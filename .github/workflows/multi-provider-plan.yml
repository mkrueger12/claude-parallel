name: Multi-Provider Plan Generation

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to generate plan for'
        required: true
        type: number
      linear_project_id:
        description: 'Linear project ID to add issues to (optional)'
        required: false
        type: string
      anthropic_model:
        description: 'Anthropic model to use'
        required: false
        type: string
        default: 'claude-opus-4-5-20251101'
      openai_model:
        description: 'OpenAI model to use'
        required: false
        type: string
        default: 'gpt-5.2'
      google_model:
        description: 'Google model to use'
        required: false
        type: string
        default: 'gemini-3-pro'

jobs:
  generate-plan:
    # Only run if label is 'claude-plan' OR event is workflow_dispatch
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'claude-plan'))
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get issue details
        id: issue
        uses: ./.github/actions/get-issue-details
        with:
          issue_number: ${{ github.event_name == 'workflow_dispatch' && inputs.issue_number || github.event.issue.number }}
          github_token: ${{ secrets.GH_PAT }}
          event_name: ${{ github.event_name }}
          event_issue_number: ${{ github.event.issue.number || '' }}

      - name: Setup OpenCode
        uses: ./.github/actions/setup-opencode
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          openai_api_key: ${{ secrets.OPENAI_API_KEY }}
          google_api_key: ${{ secrets.GOOGLE_GENERATIVE_AI_API_KEY }}
          linear_api_key: ${{ secrets.LINEAR_API_KEY }}
          linear_team_id: ${{ secrets.LINEAR_TEAM_ID }}
          linear_project_id: ${{ github.event_name == 'workflow_dispatch' && inputs.linear_project_id || secrets.LINEAR_PROJECT_ID }}
          anthropic_model: ${{ github.event_name == 'workflow_dispatch' && inputs.anthropic_model || 'claude-sonnet-4-20250514' }}
          openai_model: ${{ github.event_name == 'workflow_dispatch' && inputs.openai_model || 'gpt-4-turbo-preview' }}
          google_model: ${{ github.event_name == 'workflow_dispatch' && inputs.google_model || 'gemini-pro' }}

      - name: Set environment variables
        run: |
          echo "GITHUB_ISSUE_URL=${{ github.event.repository.html_url }}/issues/${{ steps.issue.outputs.number }}" >> $GITHUB_ENV
          echo "ISSUE_TITLE=${{ steps.issue.outputs.title }}" >> $GITHUB_ENV

      - name: Generate plans and create Linear issues
        id: generate
        run: |
          cd ${{ github.workspace }}/.github/scripts

          # Read issue body
          ISSUE_BODY=$(cat ${{ steps.issue.outputs.body_file }})

          # Run the combined script that:
          # 1. Generates plans from 3 providers in parallel
          # 2. Consolidates them
          # 3. Creates Linear issues
          # All in one execution - no intermediate files!
          node --loader ts-node/esm generate-and-create-linear.ts \
            "${{ steps.issue.outputs.title }}" \
            "$ISSUE_BODY"

      - name: Post summary comment on GitHub issue
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Extract outputs from the generation script
          PARENT_IDENTIFIER="${{ steps.generate.outputs.parent_issue_id }}"
          PARENT_URL="${{ steps.generate.outputs.parent_issue_url }}"
          SUB_ISSUE_COUNT="${{ steps.generate.outputs.sub_issues_count }}"

          # Create comment
          COMMENT="## Multi-Provider Implementation Plan Generated

          :robot: This issue has been analyzed by three AI providers (Anthropic Claude, OpenAI GPT-4, and Google Gemini), and a consolidated implementation plan has been created.

          ### Linear Parent Issue
          **[${PARENT_IDENTIFIER}](${PARENT_URL})**

          ### Implementation Steps
          ${SUB_ISSUE_COUNT} sub-issues have been created in Linear with detailed implementation steps.

          ---

          *View the full consolidated plan and track progress in Linear.*
          *Generated by Multi-Provider Plan workflow - Run #${{ github.run_id }}*"

          # Post comment to GitHub issue
          gh issue comment "${{ steps.issue.outputs.number }}" --body "$COMMENT"

          echo "Summary comment posted successfully"

      - name: Handle errors
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          ERROR_COMMENT="## Multi-Provider Plan Generation Failed

          :x: The plan generation workflow encountered an error.

          **Run ID:** ${{ github.run_id }}
          **Failed Job:** ${{ github.job }}

          Please check the [workflow run logs](${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}) for details.

          Common issues:
          - Missing or invalid API keys (CLAUDE_CODE_OAUTH_TOKEN, OPENAI_API_KEY, GOOGLE_GENERATIVE_AI_API_KEY, LINEAR_API_KEY)
          - Invalid Linear team ID or project ID
          - Provider API rate limits
          - Network connectivity issues

          ---
          *Generated by Multi-Provider Plan workflow*"

          gh issue comment "${{ steps.issue.outputs.number }}" --body "$ERROR_COMMENT" || true
