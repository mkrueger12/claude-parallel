<?xml version="1.0" encoding="UTF-8"?>
<specification>
  <project>
    <name>Claude Parallel - Installer CLI for Parallel AI Implementation Workflows</name>

    <overview>
      An npm-installable CLI tool that installs standalone GitHub Actions workflows for parallel Claude Code implementations into any repository. Once installed with `npx install-claude-parallel`, the workflows run parallel implementations, automatically review them, and create draft PRs with the best implementation. The system also supports multi-provider AI plan generation using Anthropic Claude, OpenAI GPT, and Google Gemini to create comprehensive implementation plans with Linear issue tracking.
    </overview>
  </project>

  <technology-stack>
    <core-infrastructure>
      <item name="Distribution">npm package (`install-claude-parallel`) with CLI installer</item>
      <item name="CI/CD">GitHub Actions with standalone workflows (no external references)</item>
      <item name="Scripting">Bash shell scripts, TypeScript with Bun runtime</item>
      <item name="Bundling">Bun bundler for self-contained JavaScript files</item>
      <item name="Version Control">Git with worktree support</item>
      <ai-integration>
        <item>Claude Agent SDK (`@anthropic-ai/claude-agent-sdk`) for local parallel implementations</item>
        <item>OpenCode SDK (`@opencode-ai/sdk`) for multi-provider planning</item>
        <item>Claude Code CLI (GitHub Actions workflows)</item>
        <item>Anthropic API, OpenAI API, Google Gemini API</item>
      </ai-integration>
      <item name="Issue Tracking">Linear SDK (`@linear/sdk`)</item>
      <item name="Conversation Logging">Turso (libSQL) for optional session storage</item>
      <item name="Package Manager">Bun (primary), npm, pnpm, yarn support</item>
      <item name="TypeScript">Strict mode with ES2022 target, NodeNext modules</item>
    </core-infrastructure>

    <multi-language-support>
      <language name="JavaScript/TypeScript">Node.js, Bun, npm, pnpm, yarn</language>
      <language name="Python">pip, poetry, pytest</language>
      <language name="Go">go modules, go build, go test</language>
      <language name="Rust">cargo build, cargo test</language>
      <language name="Java">Maven, Gradle</language>
      <language name="Ruby">bundler, gem</language>
      <language name="PHP">composer</language>
    </multi-language-support>

    <github-actions-architecture>
      <feature>Standalone workflows installed into user repositories</feature>
      <feature>Self-contained scripts (bundled JavaScript) for all operations</feature>
      <feature>Matrix strategy for parallel execution</feature>
      <feature>Artifact management for result sharing</feature>
      <feature>No external repository references or dependencies</feature>
    </github-actions-architecture>
  </technology-stack>

  <prerequisites>
    <for-installing>
      <requirement>Node.js >= 20.0.0 (for running `npx install-claude-parallel`)</requirement>
      <requirement>Git repository (recommended but not required)</requirement>
    </for-installing>

    <for-using-workflows>
      <requirement>GitHub repository with Actions enabled</requirement>
      <requirement>GitHub Personal Access Token (GH_PAT) with repo permissions</requirement>
      <ai-provider-auth>
        <requirement type="preferred">CLAUDE_CODE_OAUTH_TOKEN (preferred for all workflows, required for multi-provider planning)</requirement>
        <requirement type="alternative">ANTHROPIC_API_KEY (alternative for implementation workflow, fallback option)</requirement>
        <requirement type="optional">OPENAI_API_KEY (optional, for multi-provider planning)</requirement>
        <requirement type="optional">GOOGLE_GENERATIVE_AI_API_KEY (optional, for multi-provider planning)</requirement>
      </ai-provider-auth>
      <linear-credentials type="optional">
        <requirement>LINEAR_API_KEY</requirement>
        <requirement>LINEAR_TEAM_ID</requirement>
        <requirement type="optional">LINEAR_PROJECT_ID</requirement>
      </linear-credentials>
    </for-using-workflows>

    <for-development>
      <requirement>Node.js >= 20.0.0 or Bun >= 1.0.0 (Bun required for local script execution)</requirement>
      <requirement>TypeScript knowledge for modifying agents</requirement>
      <requirement>Git and gh CLI (for local shell script usage)</requirement>
      <requirement>jq (for JSON parsing in shell script)</requirement>
    </for-development>

    <for-local-script-usage>
      <requirement>Bun runtime (required) - Install via `curl -fsSL https://bun.sh/install | bash` or `npm install -g bun`</requirement>
      <requirement>CLAUDE_CODE_OAUTH_TOKEN or ANTHROPIC_API_KEY (CLAUDE_CODE_OAUTH_TOKEN preferred for local runs)</requirement>
      <requirement>Git, gh CLI, and jq utilities</requirement>
    </for-local-script-usage>
  </prerequisites>

  <core-features>
    <installer-cli>
      <distribution-method>npm package installable with `npx install-claude-parallel`</distribution-method>
      <installation-features>
        <feature>Copies standalone workflows to `.github/workflows/`</feature>
        <feature>Installs bundled scripts to `.github/claude-parallel/scripts/`</feature>
        <feature>Installs prompt templates to `.github/claude-parallel/prompts/`</feature>
        <feature>Installs Claude Code agents to `.claude/agents/`</feature>
        <feature>Creates `.env.example` with documented secrets</feature>
      </installation-features>
      <update-management>
        <feature>Manifest-based file tracking with SHA-256 hashes</feature>
        <feature>Detects user modifications and preserves them</feature>
        <feature>Safe re-runs update only unchanged files</feature>
        <feature>`--force` flag for complete overwrite</feature>
      </update-management>
      <cli-flags>
        <flag name="--help">Show usage information</flag>
        <flag name="--yes">Skip confirmation prompts</flag>
        <flag name="--dry-run">Preview changes without applying</flag>
        <flag name="--force">Overwrite all files including user modifications</flag>
      </cli-flags>
      <installed-files total="17">
        <count>2 workflows (claude-plan.yml, claude-implement.yml)</count>
        <count>4 bundled scripts (planning-agent.js, linear-agent.js, claude-agent-runner.js, detect-runtime.sh)</count>
        <count>5 prompt templates</count>
        <count>4 agent definitions</count>
        <count>1 .env.example</count>
        <count>1 .install-manifest.json</count>
      </installed-files>
    </installer-cli>

    <parallel-implementation-workflow>
      <trigger-methods>
        <method>GitHub issue label (`claude-implement`)</method>
        <method>Manual workflow dispatch with issue number</method>
      </trigger-methods>
      <matrix-based-execution>
        <feature>Configurable number of implementations (default: 3)</feature>
        <feature>Independent execution in separate branches</feature>
        <feature>Concurrent runtime for maximum efficiency</feature>
      </matrix-based-execution>
      <automated-branch-management>
        <feature>Branch naming: `impl-{run_id}-{impl_number}`</feature>
        <feature>Automatic cleanup of non-winning branches</feature>
        <feature>Winning branch preserved for PR</feature>
      </automated-branch-management>
      <smart-runtime-detection>
        <feature>Auto-detects project language and package manager</feature>
        <feature>Sets up appropriate environment (Node.js, Python, Go, Rust, etc.)</feature>
        <feature>Installs dependencies automatically</feature>
        <feature>Supports custom runtime configurations</feature>
      </smart-runtime-detection>
    </parallel-implementation-workflow>

    <ai-powered-implementation>
      <claude-code-integration>
        <feature>Headless CLI execution</feature>
        <feature>JSON output format for parsing</feature>
        <feature>Configurable model selection (Opus, Sonnet, Haiku)</feature>
        <feature>Custom prompt templates with variable substitution</feature>
        <feature>Structured output with JSON schema validation</feature>
      </claude-code-integration>
      <custom-agent-system>
        <feature>Installed in `.claude/agents/` directory</feature>
        <feature>Specialized agents for different tasks</feature>
        <feature>Agent delegation for planning and implementation</feature>
        <feature>Research agents (codebase-locator, codebase-analyzer)</feature>
        <feature>Implementation agents (coding-agent)</feature>
        <feature>Debug agent (debug-agent)</feature>
      </custom-agent-system>
      <prompt-template-system>
        <feature>Markdown-based prompt templates installed in `.github/claude-parallel/prompts/`</feature>
        <feature>Variable substitution (FEATURE_REQUEST, NUM_IMPLEMENTATIONS, etc.)</feature>
        <feature>Templates are standalone files (no external fetching)</feature>
        <feature>Customizable by users after installation</feature>
      </prompt-template-system>
    </ai-powered-implementation>

    <automated-code-review>
      <multi-implementation-comparison>
        <feature>Reviews all implementations via git diff</feature>
        <feature>Evaluates code quality, completeness, maintainability</feature>
        <feature>Structured decision output with JSON schema</feature>
        <feature>Detailed reasoning for selection</feature>
      </multi-implementation-comparison>
      <review-criteria>
        <criterion>Code quality and style consistency</criterion>
        <criterion>Feature completeness</criterion>
        <criterion>Error handling</criterion>
        <criterion>Test coverage</criterion>
        <criterion>Documentation</criterion>
        <criterion>Performance considerations</criterion>
      </review-criteria>
      <robust-parsing>
        <feature>Multiple parsing strategies for Claude output</feature>
        <feature>Handles structured_output, result field, and root-level JSON</feature>
        <feature>Fallback regex extraction</feature>
        <feature>Detailed error messages for debugging</feature>
      </robust-parsing>
    </automated-code-review>

    <automated-verification>
      <build-checks>
        <feature>Language-specific build commands</feature>
        <feature>Compilation verification</feature>
        <feature>Build artifact validation</feature>
        <feature>Error output capture</feature>
      </build-checks>
      <test-execution>
        <feature>Unit tests</feature>
        <feature>Integration tests</feature>
        <feature>Test coverage reporting</feature>
        <feature>Failure diagnostics</feature>
      </test-execution>
      <code-quality>
        <feature>Linting (ESLint, ruff, golint, clippy)</feature>
        <feature>Type checking (TypeScript, mypy)</feature>
        <feature>Code formatting validation</feature>
        <feature>Style guide compliance</feature>
      </code-quality>
      <automated-pr-comments>
        <feature>Verification status table</feature>
        <feature>Build/test/lint/typecheck results</feature>
        <feature>Summary of issues found</feature>
        <feature>Links to detailed logs</feature>
      </automated-pr-comments>
    </automated-verification>

    <multi-provider-plan-generation>
      <architecture version="2" approach="Parallel Jobs">
        <feature>Three concurrent GitHub Actions jobs</feature>
        <feature>Each provider runs independently</feature>
        <feature>Plans passed via job outputs</feature>
        <feature>Better visibility in GitHub UI</feature>
        <feature>Fail-fast: stops if any provider fails</feature>
        <feature>Idiomatic GitHub Actions patterns</feature>
        <feature>Clear failure indication per provider</feature>
      </architecture>
      <features>
        <parallel-plan-generation>
          <provider name="Anthropic Claude" default-model="claude-sonnet-4-5"/>
          <provider name="OpenAI GPT" default-model="gpt-5.1-codex-max"/>
          <provider name="Google Gemini" default-model="gemini-2.5-pro"/>
          <feature>Concurrent execution for speed</feature>
          <feature>Independent context per provider</feature>
        </parallel-plan-generation>
        <plan-consolidation>
          <feature>AI-driven analysis of all plans</feature>
          <feature>Unified implementation strategy</feature>
          <feature>Best practices from multiple perspectives</feature>
          <feature>Consensus-based approach selection</feature>
        </plan-consolidation>
        <linear-issue-creation>
          <feature>Parent issue with consolidated plan</feature>
          <feature>Sub-issues for implementation tasks</feature>
          <feature>Automatic linking and organization</feature>
          <feature>Project assignment support</feature>
          <feature>GitHub issue reference in Linear</feature>
        </linear-issue-creation>
      </features>
    </multi-provider-plan-generation>

    <local-cli-support>
      <shell-script-execution>
        <feature>Direct command-line usage</feature>
        <feature>Git worktree management</feature>
        <feature>Local Claude Code execution</feature>
        <feature>Manual PR creation option</feature>
      </shell-script-execution>
      <worktree-management>
        <feature>Parallel worktree creation</feature>
        <feature>Independent directory structure</feature>
        <feature>Automatic cleanup options</feature>
        <feature>Result aggregation</feature>
      </worktree-management>
      <flexible-configuration>
        <feature>Configurable implementation count</feature>
        <feature>Custom worktree location</feature>
        <feature>Adjustable review criteria</feature>
        <feature>Keep-all-implementations mode</feature>
      </flexible-configuration>
    </local-cli-support>

    <conversation-logging>
      <storage-backend>Turso (libSQL) for edge-compatible SQLite</storage-backend>
      <optional-feature>Enabled via environment variables, zero impact when disabled</optional-feature>
      <data-captured>
        <item>Sessions: Agent type, model, provider, start/end times, status</item>
        <item>Messages: Role, content, sequence, token counts</item>
        <item>Tool executions: Name, input/output, duration, errors</item>
      </data-captured>
      <query-api>
        <method name="listSessions">Paginated listing with filters</method>
        <method name="getSession">Full session details</method>
        <method name="searchSessions">Full-text search on message content</method>
        <method name="getSessionStats">Aggregate statistics</method>
      </query-api>
      <environment-variables>
        <variable name="TURSO_DATABASE_URL">Database connection URL</variable>
        <variable name="TURSO_AUTH_TOKEN">Authentication token</variable>
      </environment-variables>
      <features>
        <feature>Automatic Initialization: Database schema created on first use</feature>
        <feature>Fire-and-Forget: Logging operations don't block agent execution</feature>
        <feature>Error Handling: Gracefully handles missing config or database errors</feature>
      </features>
    </conversation-logging>

    <draft-pr-creation>
      <automatic-pr-generation>
        <feature>Draft status for review</feature>
        <feature>Descriptive title from issue</feature>
        <feature>Implementation selection reasoning</feature>
        <feature>Links to original issue</feature>
        <feature>Generated by workflow attribution</feature>
      </automatic-pr-generation>
      <pr-metadata>
        <item>Selected implementation number</item>
        <item>Review reasoning</item>
        <item>Verification results</item>
        <item>Build status badges</item>
        <item>Issue references</item>
      </pr-metadata>
    </draft-pr-creation>
  </core-features>

  <github-actions-workflows>
    <main-workflows>
      <workflow name="reusable-implement-issue.yml">
        <description>Reusable Implement Issue</description>
        <inputs>
          <input name="issue_number">Issue to implement</input>
          <input name="num_implementations" default="3">Number of parallel runs</input>
          <input name="claude_model" default="claude-opus-4-5-20251101">AI model selection</input>
          <input name="prompts_repo" default="mkrueger12/claude-parallel">Source for prompts</input>
          <input name="prompts_ref" default="main">Git ref for prompts</input>
          <input name="bot_name">Git commit author name</input>
          <input name="bot_email">Git commit author email</input>
          <input name="dry_run" default="false">Skip AI, use mocks</input>
          <input name="event_name">Trigger event type</input>
          <input name="event_issue_number">Issue number from event</input>
        </inputs>
        <secrets>
          <secret name="CLAUDE_CODE_OAUTH_TOKEN">Claude Code OAuth token (preferred, alternative auth)</secret>
          <secret name="ANTHROPIC_API_KEY">Anthropic API key (fallback, alternative auth)</secret>
          <secret name="GH_PAT" required="true">GitHub token</secret>
          <note>Provide either CLAUDE_CODE_OAUTH_TOKEN or ANTHROPIC_API_KEY; both are supported</note>
        </secrets>
        <jobs>
          <job order="1" name="generate-matrix">Creates implementation matrix</job>
          <job order="2" name="implement">Runs N parallel implementations</job>
          <job order="3" name="review">Compares and selects best implementation</job>
          <job order="4" name="verify">Runs build/test/lint checks and posts results</job>
        </jobs>
      </workflow>

      <workflow name="multi-provider-plan-v2.yml">
        <description>Multi-Provider Plan v2</description>
        <triggers>
          <trigger>Label `claude-plan-v2` on issue</trigger>
          <trigger>Manual dispatch</trigger>
        </triggers>
        <inputs>
          <input name="issue_number">Issue to plan for</input>
          <input name="linear_project_id" optional="true">Linear project</input>
          <input name="anthropic_model" default="claude-sonnet-4-5">Claude model selection</input>
          <input name="openai_model" default="gpt-5.1-codex-max">GPT model selection</input>
          <input name="google_model" default="gemini-2.5-pro">Gemini model selection</input>
        </inputs>
        <secrets>
          <secret name="CLAUDE_CODE_OAUTH_TOKEN">Claude Code OAuth token</secret>
          <secret name="OPENAI_API_KEY">OpenAI auth</secret>
          <secret name="GOOGLE_GENERATIVE_AI_API_KEY">Google auth</secret>
          <secret name="LINEAR_API_KEY">Linear auth</secret>
          <secret name="LINEAR_TEAM_ID">Linear team</secret>
          <secret name="LINEAR_PROJECT_ID" optional="true">Linear project</secret>
          <secret name="GH_PAT">GitHub token</secret>
        </secrets>
        <jobs>
          <job order="1" name="get-issue">Fetches issue details</job>
          <job order="2" name="generate-plan-anthropic" parallel="true">Generates plan from Claude</job>
          <job order="3" name="generate-plan-openai" parallel="true">Generates plan from GPT</job>
          <job order="4" name="generate-plan-google" parallel="true">Generates plan from Gemini</job>
          <job order="5" name="consolidate-and-create-linear">Consolidates plans and creates Linear issues</job>
        </jobs>
        <scripts>
          <script path="src/agents/planning-agent.ts">Individual provider plan generation</script>
          <script path="src/agents/linear-agent.ts">Plan consolidation and Linear issue creation</script>
        </scripts>
      </workflow>
    </main-workflows>

    <custom-actions>
      <action name="get-issue-details">
        <feature>Fetches issue title and body</feature>
        <feature>Handles workflow_dispatch and issues events</feature>
        <feature>Creates temporary files for content</feature>
        <feature>Returns issue metadata</feature>
      </action>

      <action name="setup-claude">
        <feature>Installs Claude Code CLI</feature>
        <feature>Configures authentication (OAuth or API key)</feature>
        <feature>Validates installation</feature>
        <feature>Adds to PATH</feature>
      </action>

      <action name="fetch-agents">
        <feature>Downloads custom agent definitions</feature>
        <feature>Supports external repositories</feature>
        <feature>Version control via Git refs</feature>
        <feature>Installs to Claude config directory</feature>
      </action>

      <action name="detect-runtime">
        <feature>Identifies project language</feature>
        <feature>Detects package manager</feature>
        <feature>Returns runtime configuration</feature>
        <feature>Used for environment setup</feature>
      </action>
    </custom-actions>

    <workflow-triggers>
      <via-label>
        <trigger>Add `claude-implement` label to issue → triggers parallel implementation workflow</trigger>
        <trigger>Add `claude-plan-v2` label to issue → triggers multi-provider planning</trigger>
      </via-label>
      <via-manual-dispatch>
        <step>Navigate to Actions tab</step>
        <step>Select workflow</step>
        <step>Enter issue number and parameters</step>
        <step>Click "Run workflow"</step>
      </via-manual-dispatch>
    </workflow-triggers>
  </github-actions-workflows>

  <prompt-templates>
    <template name="implementation.md">
      <variables>
        <variable name="FEATURE_REQUEST">Issue title and body</variable>
      </variables>
      <structure>
        <item>Orientation commands (pwd, ls, cat spec.txt)</item>
        <item>Planning phase with subagent delegation</item>
        <item>Research task spawning (codebase-locator, codebase-analyzer, general-purpose)</item>
        <item>Plan.md creation with template structure</item>
        <item>Features.json creation for E2E tests</item>
        <item>Implementation phase with coding-agent delegation</item>
        <item>Success criteria (automated and manual)</item>
      </structure>
      <key-guidelines>
        <guideline>Be skeptical of vague requirements</guideline>
        <guideline>Be thorough with research</guideline>
        <guideline>Be practical with incremental changes</guideline>
        <guideline>Track progress with TodoWrite</guideline>
        <guideline>No open questions in final plan</guideline>
        <guideline>Unlimited time for quality</guideline>
      </key-guidelines>
    </template>

    <template name="review.md">
      <variables>
        <variable name="FEATURE_REQUEST">Original request</variable>
        <variable name="WORKTREES_DIR">Path to worktrees</variable>
        <variable name="NUM_IMPLEMENTATIONS">Count of implementations</variable>
      </variables>
      <output-schema>
        <json-schema>
          {
            "type": "object",
            "properties": {
              "best": {"type": "integer", "minimum": 1},
              "reasoning": {"type": "string"}
            },
            "required": ["best", "reasoning"]
          }
        </json-schema>
      </output-schema>
      <evaluation-criteria>
        <criterion>Code quality and maintainability</criterion>
        <criterion>Feature completeness</criterion>
        <criterion>Test coverage</criterion>
        <criterion>Documentation quality</criterion>
        <criterion>Adherence to project conventions</criterion>
      </evaluation-criteria>
    </template>

    <template name="verify.md">
      <variables>
        <variable name="FEATURE_REQUEST">Original request</variable>
        <variable name="WINNING_BRANCH">Selected branch</variable>
        <variable name="PR_NUMBER">PR number</variable>
        <variable name="BUILD_STATUS">Build result</variable>
        <variable name="TESTS_STATUS">Test result</variable>
        <variable name="LINT_STATUS">Lint result</variable>
        <variable name="TYPECHECK_STATUS">Typecheck result</variable>
        <variable name="BUILD_OUTPUT">Full build logs</variable>
      </variables>
      <purpose>
        <item>Verify implementation meets requirements</item>
        <item>Analyze build/test failures</item>
        <item>Provide actionable feedback</item>
        <item>Suggest fixes for issues</item>
      </purpose>
    </template>

    <template name="plan-generation.md">
      <variables>
        <variable name="ISSUE_TITLE">Issue title</variable>
        <variable name="ISSUE_BODY">Issue description</variable>
      </variables>
      <output>
        <item>Detailed implementation approach</item>
        <item>Step-by-step task breakdown</item>
        <item>Risk analysis and mitigations</item>
        <item>Required dependencies</item>
        <item>Architecture considerations</item>
      </output>
    </template>

    <template name="consolidate-and-create-linear.md">
      <variables>
        <variable name="ANTHROPIC_PLAN">Plan from Claude</variable>
        <variable name="OPENAI_PLAN">Plan from GPT</variable>
        <variable name="GOOGLE_PLAN">Plan from Gemini</variable>
        <variable name="LINEAR_TEAM_ID">Linear team</variable>
        <variable name="LINEAR_PROJECT_ID" optional="true">Linear project</variable>
        <variable name="GITHUB_ISSUE_URL">Original issue link</variable>
      </variables>
      <actions>
        <action>Analyze all three plans</action>
        <action>Identify common themes and divergences</action>
        <action>Consolidate into unified strategy</action>
        <action>Create Linear parent issue with consolidated plan</action>
        <action>Create Linear sub-issues for tasks</action>
        <action>Link issues appropriately</action>
      </actions>
    </template>
  </prompt-templates>

  <local-script-usage>
    <shell-script name="parallel-impl.sh">
      <dependencies>git, bun, gh, jq (note: uses Bun runtime, not direct Claude CLI)</dependencies>
      <usage>./parallel-impl.sh "feature description"</usage>
      <workflow>
        <step order="1">Creates N worktrees in `../parallel-impls/`</step>
        <step order="2">Runs OpenCode SDK in each worktree (parallel) via `claude-agent-runner.ts`</step>
        <step order="3">Reviews all implementations</step>
        <step order="4">Creates draft PR from winner</step>
        <step order="5">Cleans up losing branches</step>
      </workflow>
      <configuration>
        <option name="NUM_IMPLEMENTATIONS">Number of parallel runs</option>
        <option name="WORKTREES_DIR">Worktree location</option>
        <option name="prompts">Edit prompts in `prompts/` directory</option>
      </configuration>
    </shell-script>

    <technical-details>
      <description>
        The local `parallel-impl.sh` script uses the **Claude Agent SDK** (`@anthropic-ai/claude-agent-sdk`) instead of direct Claude CLI calls:
      </description>
      <architecture>
        <item>Script invokes `bun run scripts/claude-agent-runner.ts` for AI interactions</item>
        <item>`claude-agent-runner.ts` uses the Claude Agent SDK's `query()` function</item>
        <item>Mimics Claude Code CLI behavior with proper project settings loading</item>
        <item>Output is returned as structured JSON for parsing</item>
      </architecture>
      <benefits>
        <benefit>Better integration with Anthropic's AI via official SDK</benefit>
        <benefit>Support for structured output and tool calling</benefit>
        <benefit>Improved error handling and logging</benefit>
        <benefit>MCP (Model Context Protocol) server support</benefit>
        <benefit>No need to install Claude CLI separately for local runs</benefit>
      </benefits>
      <authentication>
        <method preference="preferred">CLAUDE_CODE_OAUTH_TOKEN</method>
        <method preference="fallback">ANTHROPIC_API_KEY</method>
        <note>SDK auto-detects and uses available credentials</note>
      </authentication>
      <sdk-note>
        This project uses **two different SDKs**:
        - **Claude Agent SDK** (`@anthropic-ai/claude-agent-sdk`): Used by `parallel-impl.sh` and `scripts/claude-agent-runner.ts` for local parallel implementations
        - **OpenCode SDK** (`@opencode-ai/sdk`): Used by multi-provider planning agents (`src/agents/planning-agent.ts`, `src/agents/linear-agent.ts`) to support multiple AI providers (Anthropic, OpenAI, Google)
      </sdk-note>
    </technical-details>

    <worktree-structure>
      <![CDATA[
../parallel-impls/
  impl-{timestamp}-1/
    - Full git worktree
    - result.json (Claude output)
    - error.log (if applicable)
  impl-{timestamp}-2/
    - Full git worktree
    - result.json
  impl-{timestamp}-3/
    - Full git worktree
    - result.json
      ]]>
    </worktree-structure>
  </local-script-usage>

  <project-file-structure>
    <![CDATA[
claude-parallel/
├── .github/
│   ├── workflows/
│   │   ├── reusable-implement-issue.yml    # Legacy reusable workflow (for reference)
│   │   ├── claude-implement-issue.yml       # Caller workflow example
│   │   ├── multi-provider-plan-v2.yml       # Multi-provider planning workflow
│   │   └── claude.yml                       # Claude Code action workflow
│   └── actions/
│       ├── get-issue-details/              # Fetch issue metadata
│       ├── setup-claude/                   # Install Claude CLI
│       ├── setup-opencode/                 # Setup OpenCode SDK server
│       ├── fetch-agents/                   # Download custom agents
│       └── detect-runtime/                 # Detect language/package manager
├── .claude/
│   └── agents/                             # Custom Claude Code agents
│       ├── coding-agent.md                 # Feature implementation agent
│       ├── codebase-locator.md             # File/component finder agent
│       ├── codebase-analyzer.md            # Implementation analysis agent
│       └── debug-agent.md                  # Debugging agent
├── scripts/                                # Utility scripts
│   ├── claude-agent-runner.ts              # CLI wrapper for Claude Agent SDK
│   ├── build-templates.ts                  # Build script for bundling templates
│   └── test-install.sh                     # Installation test script
├── src/                                    # TypeScript source code
│   ├── agents/
│   │   ├── planning-agent.ts               # Single provider plan generation (OpenCode SDK)
│   │   └── linear-agent.ts                 # Plan consolidation and Linear creation (OpenCode SDK)
│   ├── cli/                                # Installer CLI source
│   │   ├── index.ts                        # CLI entry point
│   │   ├── install.ts                      # Main install logic
│   │   └── manifest.ts                     # Manifest read/write and hashing
│   ├── lib/
│   │   ├── types.ts                        # Shared TypeScript interfaces
│   │   ├── utils.ts                        # Utility functions
│   │   ├── opencode.ts                     # OpenCode SDK helpers (multi-provider)
│   │   └── claude-agent-sdk.ts             # Claude Agent SDK helpers (local parallel impl)
│   └── index.ts                            # Public API exports
├── dist/                                   # Compiled TypeScript output
│   ├── agents/
│   ├── cli/                                # Compiled CLI code
│   ├── lib/
│   └── index.js                            # Compiled entry point
├── templates/                              # Template files for installation
│   ├── workflows/
│   │   ├── claude-plan.yml                 # Standalone planning workflow template
│   │   └── claude-implement.yml            # Standalone implementation workflow template
│   ├── scripts/
│   │   ├── planning-agent.js               # Bundled planning agent (46KB)
│   │   ├── linear-agent.js                 # Bundled linear agent (47KB)
│   │   ├── claude-agent-runner.js          # Bundled agent runner (453KB)
│   │   └── detect-runtime.sh               # Runtime detection bash script
│   ├── prompts/
│   │   ├── plan-generation.md              # Plan generation prompt
│   │   ├── consolidate-and-create-linear.md # Plan consolidation prompt
│   │   ├── implementation.md               # Implementation prompt
│   │   ├── review.md                       # Review prompt
│   │   └── verify.md                       # Verification prompt
│   ├── agents/
│   │   ├── coding-agent.md                 # Coding agent definition
│   │   ├── codebase-locator.md             # Locator agent definition
│   │   ├── codebase-analyzer.md            # Analyzer agent definition
│   │   └── debug-agent.md                  # Debug agent definition
│   └── .env.example                        # Environment variables template
├── docs/
│   └── installer.md                        # Installer documentation
├── prompts/                                # Source prompts (copied to templates/)
│   ├── implementation.md
│   ├── review.md
│   ├── verify.md
│   ├── plan-generation.md
│   └── consolidate-and-create-linear.md
├── .sessions/                              # Session tracking (if using sessions pattern)
├── parallel-impl.sh                        # Local CLI script
├── package.json                            # Node.js dependencies and scripts (install-claude-parallel)
├── bun.lock                                # Bun lockfile
├── tsconfig.json                           # TypeScript configuration
├── spec.txt                                # This file - project specification
├── CLAUDE.md                               # Claude Code guidance documentation
└── README.md                               # User documentation

Additional directories created at runtime:
node_modules/                               # Installed dependencies
../parallel-impls/                          # Worktrees for local execution
  impl-{timestamp}-{n}/                     # Individual implementation worktrees

After installation in user repository:
user-repo/
├── .github/
│   ├── workflows/
│   │   ├── claude-plan.yml                 # Multi-provider planning workflow
│   │   └── claude-implement.yml            # Parallel implementation workflow
│   └── claude-parallel/
│       ├── scripts/                        # Bundled scripts (4 files)
│       ├── prompts/                        # Prompt templates (5 files)
│       └── .install-manifest.json          # Installation manifest with file hashes
├── .claude/
│   └── agents/                             # Claude Code agents (4 files)
└── .env.example                            # Documented environment variables
    ]]>
  </project-file-structure>

  <usage-patterns>
    <pattern number="1" name="Label-Triggered Implementation">
      <step order="1">User creates GitHub issue describing feature</step>
      <step order="2">User adds `claude-implement` label</step>
      <step order="3">Workflow triggers automatically</step>
      <step order="4">N implementations execute in parallel</step>
      <step order="5">Best implementation selected via AI review</step>
      <step order="6">Draft PR created automatically</step>
      <step order="7">Verification runs and posts results to PR</step>
      <step order="8">Developer reviews and merges PR</step>
    </pattern>

    <pattern number="2" name="Manual Implementation">
      <step order="1">Developer navigates to Actions tab</step>
      <step order="2">Selects "Claude Implement Issue" workflow</step>
      <step order="3">Enters issue number</step>
      <step order="4">Optionally overrides defaults (num_implementations, model, etc.)</step>
      <step order="5">Clicks "Run workflow"</step>
      <step order="6">Monitors progress in Actions tab</step>
      <step order="7">Reviews draft PR when complete</step>
      <step order="8">Checks verification results</step>
      <step order="9">Merges or requests changes</step>
    </pattern>

    <pattern number="3" name="Multi-Provider Planning">
      <step order="1">User creates issue with complex feature request</step>
      <step order="2">User adds `claude-plan-v2` label</step>
      <step order="3">Three concurrent GitHub jobs generate plans (better visibility)</step>
      <step order="4">Plans passed to consolidation job via outputs</step>
      <step order="5">Consolidation job creates Linear parent issue</step>
      <step order="6">Consolidation job creates Linear sub-issues</step>
      <step order="7">Comment posted on GitHub issue with Linear links and provider status</step>
      <step order="8">Team reviews plan in Linear</step>
      <step order="9">Assigns tasks from sub-issues</step>
      <step order="10">Optionally triggers implementation workflow</step>
    </pattern>

    <pattern number="4" name="Local CLI Execution">
      <step order="1">Developer navigates to project directory</step>
      <step order="2">Runs `../claude-parallel/parallel-impl.sh "feature"`</step>
      <step order="3">Script creates worktrees</step>
      <step order="4">Claude Code runs in each worktree</step>
      <step order="5">Review selects best implementation</step>
      <step order="6">Draft PR created via gh CLI</step>
      <step order="7">Developer pushes and reviews locally</step>
      <step order="8">Manual merge when satisfied</step>
    </pattern>
  </usage-patterns>

  <success-criteria>
    <implementation-quality>
      <criterion>Selected implementation fully addresses issue requirements</criterion>
      <criterion>Code follows project conventions and style</criterion>
      <criterion>Tests pass (unit, integration, E2E)</criterion>
      <criterion>No regressions introduced</criterion>
      <criterion>Documentation updated where needed</criterion>
      <criterion>Build succeeds without errors</criterion>
      <criterion>Linting passes</criterion>
      <criterion>Type checking passes (if applicable)</criterion>
    </implementation-quality>

    <workflow-reliability>
      <criterion>Matrix generation succeeds</criterion>
      <criterion>All parallel jobs complete (may include failures)</criterion>
      <criterion>Review completes and selects winner</criterion>
      <criterion>PR creation succeeds</criterion>
      <criterion>Branch cleanup works correctly</criterion>
      <criterion>Artifacts uploaded and downloadable</criterion>
      <criterion>Error handling graceful</criterion>
      <criterion>Logs provide debugging info</criterion>
    </workflow-reliability>

    <user-experience>
      <criterion>Clear PR descriptions with reasoning</criterion>
      <criterion>Verification results visible in PR comments</criterion>
      <criterion>Failed implementations logged for debugging</criterion>
      <criterion>Dry-run mode works for testing</criterion>
      <criterion>Custom prompts easy to modify</criterion>
      <criterion>Documentation clear and complete</criterion>
      <criterion>Setup straightforward for new users</criterion>
    </user-experience>

    <multi-provider-planning>
      <criterion>All 3 providers generate valid plans</criterion>
      <criterion>Consolidation produces coherent strategy</criterion>
      <criterion>Linear issues created successfully</criterion>
      <criterion>Issue linking works correctly</criterion>
      <criterion>GitHub comment posted with links</criterion>
      <criterion>Plans are diverse and thoughtful</criterion>
      <criterion>Consolidated plan addresses all requirements</criterion>
    </multi-provider-planning>

    <performance>
      <criterion>Parallel execution faster than sequential</criterion>
      <criterion>Review completes in reasonable time</criterion>
      <criterion>Cleanup happens promptly</criterion>
      <criterion>No hanging jobs or resource leaks</criterion>
      <criterion>Artifact storage within limits</criterion>
      <criterion>API rate limits respected</criterion>
    </performance>
  </success-criteria>

  <typescript-development>
    <building-and-type-checking>
      <description>The project includes TypeScript code in the `src/` directory that must be compiled to JavaScript:</description>
      <commands>
        <![CDATA[
# Install dependencies
bun install

# Compile TypeScript to dist/
bun run build

# Run type checking without emitting files
bun run type-check

# Run agents directly (no build needed with Bun)
bun run planning-agent "Feature description"
bun run linear-agent

# Test claude-agent-runner (used by parallel-impl.sh)
echo "Your prompt here" | bun run claude-agent-runner --cwd $(pwd) --mode implementation
        ]]>
      </commands>
    </building-and-type-checking>

    <typescript-structure>
      <directory name="scripts">
        <description>Utility scripts</description>
        <file name="claude-agent-runner.ts">CLI wrapper for running Claude Agent SDK queries (used by `parallel-impl.sh`)</file>
      </directory>
      <directory name="src/agents">
        <description>Agent implementations using OpenCode SDK</description>
        <file name="planning-agent.ts">Generates plans from a single AI provider (supports Anthropic, OpenAI, Google)</file>
        <file name="linear-agent.ts">Consolidates plans and creates Linear issues</file>
      </directory>
      <directory name="src/lib">
        <description>Shared libraries and utilities</description>
        <file name="types.ts">TypeScript interfaces (Provider, Part, etc.)</file>
        <file name="utils.ts">Utility functions (extractTextFromParts, getApiKey)</file>
        <file name="opencode.ts">OpenCode SDK helpers (createOpencodeServer, setupEventMonitoring)</file>
        <file name="claude-agent-sdk.ts">Claude Agent SDK helpers (getAuthentication, runClaudeQuery)</file>
      </directory>
      <directory name="src">
        <file name="index.ts">Public API exports</file>
      </directory>
      <directory name="dist">
        <description>Compiled JavaScript output (committed to repo)</description>
      </directory>
    </typescript-structure>

    <typescript-configuration>
      <description>The `tsconfig.json` uses strict settings:</description>
      <settings>
        <setting name="Target">ES2022</setting>
        <setting name="Module">NodeNext (ESM)</setting>
        <setting name="Strict type checking">enabled</setting>
        <setting name="Source maps and declarations">generated</setting>
        <setting name="Output directory">dist/</setting>
      </settings>
    </typescript-configuration>
  </typescript-development>

  <configuration-and-customization>
    <changing-default-models>
      <description>Edit workflow inputs or workflow_dispatch defaults:</description>
      <providers>
        <provider name="Anthropic">claude-opus-4-5-20251101, claude-sonnet-4-5 (current default)</provider>
        <provider name="OpenAI">gpt-5.1-codex-max (current default), gpt-4-turbo, gpt-4</provider>
        <provider name="Google">gemini-2.5-pro (current default), gemini-1.5-pro</provider>
      </providers>
    </changing-default-models>

    <adjusting-implementation-count>
      <description>Set `num_implementations` input:</description>
      <options>
        <option count="1">Single implementation (fastest, no comparison)</option>
        <option count="2">Quick comparison (moderate cost)</option>
        <option count="3">Default balance (good diversity)</option>
        <option count="5+">Maximum diversity (higher cost)</option>
      </options>
    </adjusting-implementation-count>

    <custom-prompts>
      <description>Fork repository and modify files in `prompts/`:</description>
      <steps>
        <step>Use placeholders: `{{VARIABLE_NAME}}`</step>
        <step>Test locally before deploying</step>
        <step>Version control via Git refs</step>
        <step>Reference fork in workflows</step>
      </steps>
    </custom-prompts>

    <adding-new-runtimes>
      <description>Edit `.github/actions/detect-runtime/action.yml`:</description>
      <steps>
        <step>Add new file patterns</step>
        <step>Add setup steps in workflow</step>
        <step>Add build/test commands</step>
        <step>Test with dry-run mode</step>
      </steps>
    </adding-new-runtimes>

    <organization-specific-setup>
      <step order="1">Fork `mkrueger12/claude-parallel`</step>
      <step order="2">Customize prompts in `prompts/`</step>
      <step order="3">Adjust review criteria in `review.md`</step>
      <step order="4">Add organization-specific agents in `.claude/agents/`</step>
      <step order="5">Update workflow references to your fork</step>
      <step order="6">Configure secrets in organization settings</step>
      <step order="7">Deploy to repositories</step>
      <step order="8">
        If modifying TypeScript code:
        - Run `bun install` to install dependencies
        - Run `bun run build` to compile TypeScript
        - Commit both `src/` and `dist/` changes
      </step>
    </organization-specific-setup>
  </configuration-and-customization>

  <cost-considerations>
    <token-usage-estimates>
      <estimate type="simple-feature">~30k tokens per implementation</estimate>
      <estimate type="complex-feature">~100k tokens per implementation</estimate>
      <estimate type="review">~50k tokens</estimate>
      <estimate type="verification">~20k tokens</estimate>
      <estimate type="total-3-implementations">~150k-350k tokens</estimate>
    </token-usage-estimates>

    <multi-provider-planning>
      <estimate type="each-provider-plan">~50k tokens</estimate>
      <estimate type="consolidation">~100k tokens</estimate>
      <estimate type="total">~250k tokens across all providers</estimate>
    </multi-provider-planning>

    <optimization-strategies>
      <strategy>Use Haiku model for simple tasks (lower cost)</strategy>
      <strategy>Reduce num_implementations for straightforward features</strategy>
      <strategy>Use dry-run mode for testing workflows</strategy>
      <strategy>Cache dependencies in Actions</strategy>
      <strategy>Clean up artifacts promptly</strategy>
      <strategy>Monitor API usage dashboards</strategy>
    </optimization-strategies>
  </cost-considerations>

  <troubleshooting>
    <common-issues>
      <issue name="Not in a git repository">
        <solution>Run from within a git repository</solution>
        <solution>Ensure .git directory exists</solution>
        <solution>Check git config is valid</solution>
      </issue>

      <issue name="Required command not found">
        <solution>Install missing dependencies (git, claude, gh, jq)</solution>
        <solution>Check PATH includes executable locations</solution>
        <solution>Verify Claude CLI installation</solution>
      </issue>

      <issue name="Linear API key is invalid">
        <solution>Get new key from https://linear.app/settings/api</solution>
        <solution>Update GitHub secret LINEAR_API_KEY</solution>
        <solution>Verify team ID is correct</solution>
      </issue>

      <issue name="Claude CLI returned an error">
        <solution>Check rate limits (wait for reset)</solution>
        <solution>Verify authentication secrets</solution>
        <solution>Check API status</solution>
        <solution>Review error logs in artifacts</solution>
      </issue>

      <issue name="Could not find decision JSON">
        <solution>Review parsing strategies in logs</solution>
        <solution>Check Claude output format</solution>
        <solution>Verify JSON schema in prompt</solution>
        <solution>Inspect raw review-result.json</solution>
      </issue>

      <issue name="Verification failed">
        <solution>Check build logs in /tmp/build-results/</solution>
        <solution>Review test failures</solution>
        <solution>Fix code and re-run verification</solution>
        <solution>Update tests if requirements changed</solution>
      </issue>

      <issue name="Workflow doesn't trigger on label">
        <solution>Verify label name is exact: `claude-implement` or `claude-plan-v2`</solution>
        <solution>Check workflow file on default branch</solution>
        <solution>Ensure secrets configured</solution>
        <solution>Check Actions enabled in repo</solution>
      </issue>

      <issue name="TypeScript compilation errors">
        <solution>Run `bun install` to install dependencies</solution>
        <solution>Check `tsconfig.json` configuration</solution>
        <solution>Run `bun run type-check` to see detailed errors</solution>
        <solution>Ensure Node.js version >= 20.0.0 or Bun >= 1.0.0</solution>
      </issue>
    </common-issues>
  </troubleshooting>

  <security-considerations>
    <secret-management>
      <practice>Use GitHub Secrets for all credentials</practice>
      <practice>Never commit API keys to repository</practice>
      <practice>Rotate secrets regularly</practice>
      <practice>Use organization secrets for shared access</practice>
      <practice>Limit secret access to necessary workflows</practice>
    </secret-management>

    <code-review>
      <practice>Always review AI-generated code before merging</practice>
      <practice>Check for security vulnerabilities</practice>
      <practice>Verify input validation</practice>
      <practice>Audit dependency changes</practice>
      <practice>Review permission changes</practice>
    </code-review>

    <branch-protection>
      <practice>Require PR reviews</practice>
      <practice>Require status checks to pass</practice>
      <practice>Restrict who can merge</practice>
      <practice type="optional">Require signed commits</practice>
      <practice type="optional">Enable CODEOWNERS</practice>
    </branch-protection>

    <workflow-permissions>
      <practice>Use minimal required permissions</practice>
      <practice>GH_PAT should have limited scope</practice>
      <practice>Review Actions permissions regularly</practice>
      <practice>Audit workflow changes</practice>
      <practice>Monitor workflow runs</practice>
    </workflow-permissions>
  </security-considerations>

  <sessions-pattern-support>
    <description>The repository includes optional support for the Sessions Directory Pattern:</description>
    <features>
      <feature>`.sessions/` directory for tracking work sessions</feature>
      <feature>Slash commands: `/start-session`, `/end-session`, `/plan`, `/document`</feature>
      <feature>Automatic context management and GitHub/Linear issue fetching</feature>
      <feature>Session archiving and merged PR detection</feature>
    </features>
    <reference>See CLAUDE.md for more details on using the Sessions pattern.</reference>
  </sessions-pattern-support>

  <future-enhancements>
    <potential-features>
      <feature>Support for additional AI providers (Cohere, Mistral, etc.)</feature>
      <feature>Automated performance benchmarking</feature>
      <feature>Visual diff comparison tool</feature>
      <feature>Integration with more issue trackers (Jira, Asana)</feature>
      <feature>Code quality scoring metrics</feature>
      <feature>Automated regression testing</feature>
      <feature>Parallel review by multiple reviewers</feature>
      <feature>Cost tracking and budgeting</feature>
      <feature>Team collaboration features</feature>
      <feature>Custom agent marketplace</feature>
      <feature>SDK/NPM package for programmatic usage</feature>
    </potential-features>

    <extensibility-points>
      <point>Plugin system for custom actions</point>
      <point>Webhook integrations</point>
      <point>Custom review criteria plugins</point>
      <point>Language-specific templates</point>
      <point>Organization-specific agents</point>
      <point>Custom verification steps</point>
      <point>Report generation</point>
      <point>Metrics and analytics</point>
    </extensibility-points>
  </future-enhancements>

  <credits-and-inspiration>
    <inspired-by>
      <source>incident.io's git worktree + Claude Code workflow (https://incident.io/blog)</source>
      <source>Crystal desktop app (https://github.com/stravu/crystal)</source>
      <source>Anthropic Claude Quickstarts (https://github.com/anthropics/claude-quickstarts)</source>
    </inspired-by>

    <built-with>
      <tool>Claude Code CLI (https://github.com/anthropics/claude-code)</tool>
      <tool>GitHub Actions (https://github.com/features/actions)</tool>
      <tool>Linear API (https://linear.app/docs/api)</tool>
    </built-with>
  </credits-and-inspiration>

  <license>
    MIT License - See LICENSE file for details
  </license>
</specification>
