[
  {
    "category": "functional",
    "id": "task-1-libsql-dependency",
    "description": "@libsql/client package is added to dependencies and installs correctly",
    "plan_ref": "Task 1 - Add @libsql/client dependency",
    "steps": [
      "Check that @libsql/client is listed in package.json dependencies",
      "Run bun install and verify no errors",
      "Verify @libsql/client exists in node_modules",
      "Verify TypeScript can import createClient from @libsql/client"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "id": "task-2-turso-client-module",
    "description": "turso-client.ts module exists with createLocalClient and createRemoteClient functions",
    "plan_ref": "Task 2 - Create turso-client.ts module",
    "steps": [
      "Verify src/lib/turso-client.ts exists",
      "Verify createLocalClient function is exported",
      "Verify createRemoteClient function is exported",
      "Verify syncToCloud function is exported",
      "Verify schema constants are exported"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "id": "task-2-local-database-creation",
    "description": "createLocalClient creates .turso/sessions/ directory and database file with schema",
    "plan_ref": "Task 2 - Create turso-client.ts module",
    "steps": [
      "Call createLocalClient with a test session ID",
      "Verify .turso/sessions/ directory is created",
      "Verify database file exists at .turso/sessions/<sessionId>.db",
      "Verify sessions table exists in database",
      "Verify messages table exists in database",
      "Verify tool_calls table exists in database"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "id": "task-2-remote-client-graceful",
    "description": "createRemoteClient returns null gracefully when credentials are missing",
    "plan_ref": "Task 2 - Create turso-client.ts module",
    "steps": [
      "Ensure TURSO_DATABASE_URL is not set",
      "Ensure TURSO_AUTH_TOKEN is not set",
      "Call createRemoteClient",
      "Verify it returns null (not throws)",
      "Verify warning is logged to stderr"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "id": "task-3-conversation-logger-module",
    "description": "conversation-logger.ts module exists with ConversationLogger class",
    "plan_ref": "Task 3 - Create conversation-logger.ts module",
    "steps": [
      "Verify src/lib/conversation-logger.ts exists",
      "Verify ConversationLogger class is exported",
      "Verify constructor accepts sessionId",
      "Verify startSession method exists",
      "Verify logMessage method exists",
      "Verify endSession method exists"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "id": "task-3-session-logging",
    "description": "ConversationLogger correctly logs session start, messages, and end",
    "plan_ref": "Task 3 - Create conversation-logger.ts module",
    "steps": [
      "Create ConversationLogger instance",
      "Call startSession with metadata",
      "Verify session record inserted in database",
      "Call logMessage with mock SDK message",
      "Verify message record inserted in database",
      "Call endSession with mock result",
      "Verify session record updated with end time and duration"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "id": "task-3-error-handling",
    "description": "ConversationLogger handles errors gracefully without throwing",
    "plan_ref": "Task 3 - Create conversation-logger.ts module",
    "steps": [
      "Create ConversationLogger with invalid database path",
      "Call startSession and verify no exception thrown",
      "Call logMessage and verify no exception thrown",
      "Call endSession and verify no exception thrown",
      "Verify errors are logged to stderr"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "id": "task-4-agent-runner-integration",
    "description": "claude-agent-runner.ts imports and uses ConversationLogger",
    "plan_ref": "Task 4 - Integrate logging into claude-agent-runner.ts",
    "steps": [
      "Verify ConversationLogger import in claude-agent-runner.ts",
      "Verify session ID generation with crypto.randomUUID()",
      "Verify logger.startSession called after reading prompt",
      "Verify logger.logMessage called in message loop",
      "Verify logger.endSession called after loop completes"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "id": "task-4-session-id-logging",
    "description": "Session ID is output to stderr for debugging",
    "plan_ref": "Task 4 - Integrate logging into claude-agent-runner.ts",
    "steps": [
      "Read claude-agent-runner.ts source",
      "Verify session ID is logged to stderr",
      "Verify session ID format is UUID"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "id": "task-5-bundle-includes-logging",
    "description": "Bundled claude-agent-runner.js includes logging modules",
    "plan_ref": "Task 5 - Update build-templates.ts for bundling",
    "steps": [
      "Run bun run build:templates",
      "Verify templates/scripts/claude-agent-runner.js exists",
      "Verify bundled file contains ConversationLogger code",
      "Verify bundled file contains turso-client code",
      "Verify bundled file contains @libsql/client code"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "id": "task-6-sync-session-script",
    "description": "sync-session.ts script exists and handles sync operations",
    "plan_ref": "Task 6 - Create optional helper scripts",
    "steps": [
      "Verify scripts/sync-session.ts exists",
      "Verify script accepts session ID argument",
      "Verify script accepts --all flag",
      "Verify script handles missing credentials gracefully"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "id": "task-6-query-session-script",
    "description": "query-session.ts script exists and outputs session data",
    "plan_ref": "Task 6 - Create optional helper scripts",
    "steps": [
      "Verify scripts/query-session.ts exists",
      "Verify script accepts session ID argument",
      "Verify script supports --json flag",
      "Verify script supports --messages flag",
      "Verify script supports --tools flag"
    ],
    "passes": true
  },
  {
    "category": "functional",
    "id": "task-7-turso-documentation",
    "description": "TURSO_SETUP.md documentation exists with complete setup instructions",
    "plan_ref": "Task 7 - Add documentation",
    "steps": [
      "Verify docs/TURSO_SETUP.md exists",
      "Verify documentation includes overview section",
      "Verify documentation includes local-only usage section",
      "Verify documentation includes cloud sync setup section",
      "Verify documentation includes environment variables section",
      "Verify documentation includes example analytics queries"
    ],
    "passes": false
  },
  {
    "category": "integration",
    "id": "e2e-local-logging-works",
    "description": "End-to-end: Running agent creates local database with session data",
    "plan_ref": "Integration test for local-first logging",
    "steps": [
      "Run claude-agent-runner.ts with a test prompt",
      "Verify .turso/sessions/ directory created",
      "Verify session database file created",
      "Query database and verify session record exists",
      "Verify messages were logged",
      "Verify no errors in stderr output related to logging"
    ],
    "passes": false
  },
  {
    "category": "integration",
    "id": "e2e-no-credentials-graceful",
    "description": "End-to-end: Agent runs successfully without Turso cloud credentials",
    "plan_ref": "Integration test for graceful degradation",
    "steps": [
      "Ensure TURSO_DATABASE_URL is not set",
      "Ensure TURSO_AUTH_TOKEN is not set",
      "Run claude-agent-runner.ts with a test prompt",
      "Verify agent completes successfully (exit code 0)",
      "Verify local database was created",
      "Verify warning about missing cloud credentials in stderr"
    ],
    "passes": false
  },
  {
    "category": "functional",
    "id": "type-check-passes",
    "description": "TypeScript type checking passes for all new modules",
    "plan_ref": "All tasks - Type safety verification",
    "steps": [
      "Run bun run type-check",
      "Verify exit code is 0",
      "Verify no type errors in src/lib/turso-client.ts",
      "Verify no type errors in src/lib/conversation-logger.ts",
      "Verify no type errors in scripts/claude-agent-runner.ts"
    ],
    "passes": true
  }
]
